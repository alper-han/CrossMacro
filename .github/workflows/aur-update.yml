name: Update AUR Package

# Workflow for AUR package updates
# NOTE: Requires AUR SSH key to use this workflow

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to update (e.g., 1.0.0)'
        required: true

jobs:
  update-aur:
    name: Update AUR Package
    runs-on: ubuntu-latest
    container: archlinux:base-devel
    
    steps:
    - name: Install dependencies
      run: |
        pacman -Sy --noconfirm git openssh wget
        
    - name: Checkout code
      uses: actions/checkout@v6
    
    - name: Extract version
      id: version
      run: |
        if [ "${{ github.event_name }}" == "release" ]; then
          VERSION=${GITHUB_REF#refs/tags/v}
        else
          VERSION=${{ github.event.inputs.version }}
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Version: $VERSION"
    
    - name: Setup SSH for AUR
      env:
        AUR_SSH_KEY: ${{ secrets.AUR_SSH_KEY }}
      run: |
        mkdir -p ~/.ssh
        echo "$AUR_SSH_KEY" > ~/.ssh/id_aur
        chmod 600 ~/.ssh/id_aur
        
        # Verify key format
        echo "SSH Key first line:"
        head -n 1 ~/.ssh/id_aur
    
    - name: Test SSH Connection
      run: |
        ssh -i ~/.ssh/id_aur -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -T aur@aur.archlinux.org || true
    
    - name: Clone AUR repository
      env:
        GIT_SSH_COMMAND: ssh -i ~/.ssh/id_aur -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null
      run: |
        # Try to clone. If it fails (new package), init a new repo
        if ! git clone ssh://aur@aur.archlinux.org/crossmacro.git aur-repo; then
          echo "Clone failed or repo does not exist. Initializing new repo..."
          mkdir aur-repo
          cd aur-repo
          git init
          git remote add origin ssh://aur@aur.archlinux.org/crossmacro.git
          git checkout -b master
        fi
    
    - name: Prepare Package Files
      run: |
        VERSION=${{ steps.version.outputs.version }}
        
        # Copy PKGBUILD from source if not present or to overwrite
        cp scripts/packaging/arch/PKGBUILD aur-repo/
        
        cd aur-repo
        
        # Update PKGBUILD version
        sed -i "s/pkgver=.*/pkgver=$VERSION/" PKGBUILD
        
        # Calculate and update checksum
        wget "https://github.com/alper-han/CrossMacro/archive/v$VERSION.tar.gz" -O source.tar.gz
        SHA256=$(sha256sum source.tar.gz | cut -d' ' -f1)
        sed -i "s/sha256sums=.*/sha256sums=('$SHA256')/" PKGBUILD
        rm source.tar.gz
        
        # Update .SRCINFO
        # makepkg cannot run as root, so we create a user
        useradd builduser
        chown -R builduser:builduser .
        su builduser -c "makepkg --printsrcinfo" > .SRCINFO
    
    - name: Commit and push to AUR
      env:
        GIT_SSH_COMMAND: ssh -i ~/.ssh/id_aur -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null
      run: |
        VERSION=${{ steps.version.outputs.version }}
        cd aur-repo
        
        # Configure git for the commit
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        
        # Add safe directory to avoid git ownership errors
        git config --global --add safe.directory $(pwd)
        
        git add PKGBUILD .SRCINFO
        
        # Only commit if there are changes
        if ! git diff --quiet --cached; then
          git commit -m "Update to version $VERSION"
          git push origin master
        else
          echo "No changes to commit."
        fi
    
    - name: Cleanup
      if: always()
      run: |
        rm -rf ~/.ssh/aur
        rm -rf aur-repo
