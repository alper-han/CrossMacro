<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:CrossMacro.UI.ViewModels"
             xmlns:local="using:CrossMacro.UI.Views.Tabs"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d" d:DesignWidth="600" d:DesignHeight="500"
             x:Class="CrossMacro.UI.Views.Tabs.EditorTabView"
             x:DataType="vm:EditorViewModel">

    <UserControl.Resources>
        <local:NullableIntConverter x:Key="NullableIntConverter"/>
    </UserControl.Resources>

    <Grid RowDefinitions="*,Auto">
        
        <!-- Main Content: Action List + Properties -->
        <Grid Grid.Row="0" ColumnDefinitions="1*,1*">
            
            <!-- Left: Action List -->
            <Border Background="{DynamicResource SurfaceColor}" CornerRadius="8" Padding="12" Margin="0,0,8,0">
                <Grid RowDefinitions="Auto,*,Auto">
                    <TextBlock Grid.Row="0" Text="Actions" FontWeight="Bold" Foreground="{DynamicResource TextPrimaryBrush}" Margin="0,0,0,8"/>
                    
                    <ListBox Grid.Row="1" 
                             ItemsSource="{Binding Actions}" 
                             SelectedItem="{Binding SelectedAction}"
                             Background="Transparent"
                             SelectionMode="Single">
                        <ListBox.Styles>
                            <Style Selector="ListBoxItem">
                                <Setter Property="Padding" Value="8,6"/>
                                <Setter Property="Margin" Value="0,2"/>
                                <Setter Property="CornerRadius" Value="4"/>
                                <Setter Property="Background" Value="{DynamicResource SurfaceHoverBrush}"/>
                                <Setter Property="Foreground" Value="{DynamicResource TextPrimaryBrush}"/>
                            </Style>
                            <Style Selector="ListBoxItem:selected /template/ ContentPresenter">
                                <Setter Property="Background" Value="{DynamicResource PrimaryBrush}"/>
                            </Style>
                            <Style Selector="ListBoxItem:pointerover /template/ ContentPresenter">
                                <Setter Property="Background" Value="{DynamicResource SurfaceHoverBrush}"/>
                            </Style>
                        </ListBox.Styles>
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal" Spacing="6">
                                    <Border Background="{DynamicResource SurfaceBrush}" 
                                            CornerRadius="3" 
                                            Padding="6,2"
                                            VerticalAlignment="Center"
                                            MinWidth="24">
                                        <TextBlock Text="{Binding Index}" 
                                                   FontSize="10" 
                                                   Foreground="{DynamicResource TextSecondaryBrush}"
                                                   FontWeight="SemiBold"
                                                   HorizontalAlignment="Center"/>
                                    </Border>
                                    <TextBlock Text="{Binding DisplayName}" 
                                               TextTrimming="CharacterEllipsis"
                                               VerticalAlignment="Center"/>
                                </StackPanel>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                    
                    <!-- Action List Buttons -->
                    <StackPanel Grid.Row="2" Orientation="Horizontal" Spacing="4" Margin="0,8,0,0">
                        <Button Command="{Binding RemoveAction}"
                                IsEnabled="{Binding HasSelectedAction}"
                                ToolTip.Tip="Remove Action"
                                Background="{DynamicResource DangerBrush}"
                                Foreground="{DynamicResource TextOnColorBrush}"
                                Padding="8,4"
                                CornerRadius="4">
                            <StackPanel Orientation="Horizontal" Spacing="4">
                                <TextBlock Text="âˆ’"/>
                                <TextBlock Text="Remove"/>
                            </StackPanel>
                        </Button>
                        <Button Command="{Binding MoveUp}"
                                IsEnabled="{Binding HasSelectedAction}"
                                ToolTip.Tip="Move Up"
                                Background="{DynamicResource SurfaceHoverBrush}"
                                Foreground="{DynamicResource TextPrimaryBrush}"
                                Padding="8,4"
                                CornerRadius="4">
                            <TextBlock Text="â†‘"/>
                        </Button>
                        <Button Command="{Binding MoveDown}"
                                IsEnabled="{Binding HasSelectedAction}"
                                ToolTip.Tip="Move Down"
                                Background="{DynamicResource SurfaceHoverBrush}"
                                Foreground="{DynamicResource TextPrimaryBrush}"
                                Padding="8,4"
                                CornerRadius="4">
                            <TextBlock Text="â†“"/>
                        </Button>
                        <Button Command="{Binding DuplicateAction}"
                                IsEnabled="{Binding HasSelectedAction}"
                                ToolTip.Tip="Duplicate"
                                Background="{DynamicResource SurfaceHoverBrush}"
                                Foreground="{DynamicResource TextPrimaryBrush}"
                                Padding="8,4"
                                CornerRadius="4">
                            <TextBlock Text="ðŸ“‹" FontFamily="{StaticResource EmojiFont}"/>
                        </Button>
                    </StackPanel>
                </Grid>
            </Border>
            
            <!-- Right: Properties Panel -->
            <Border Grid.Column="1" Background="{DynamicResource SurfaceColor}" CornerRadius="8" Padding="12" Margin="8,0,0,0">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel Spacing="16">
                        
                        <!-- Add New Action Section -->
                        <Border Background="{DynamicResource SurfaceHoverBrush}" CornerRadius="6" Padding="12">
                            <StackPanel Spacing="8">
                                <TextBlock Text="Add New Action" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}"/>
                                <ComboBox ItemsSource="{Binding ActionTypes}" 
                                          SelectedItem="{Binding NewActionType}"
                                          Background="{DynamicResource SurfaceBrush}"
                                          Foreground="{DynamicResource TextPrimaryBrush}"
                                          HorizontalAlignment="Stretch">
                                    <ComboBox.ItemTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding}"/>
                                        </DataTemplate>
                                    </ComboBox.ItemTemplate>
                                </ComboBox>
                                <Button Command="{Binding AddAction}"
                                        Background="{DynamicResource PrimaryBrush}"
                                        Foreground="{DynamicResource TextOnColorBrush}"
                                        HorizontalAlignment="Stretch"
                                        HorizontalContentAlignment="Center"
                                        Padding="8,6"
                                        CornerRadius="4">
                                    <StackPanel Orientation="Horizontal" Spacing="4" HorizontalAlignment="Center">
                                        <TextBlock Text="+"/>
                                        <TextBlock Text="Add Action"/>
                                    </StackPanel>
                                </Button>
                            </StackPanel>
                        </Border>
                        
                        <!-- Selected Action Properties -->
                        <StackPanel Spacing="12" IsVisible="{Binding HasSelectedAction}">
                            <TextBlock Text="Selected Action Properties" FontWeight="SemiBold" Foreground="{DynamicResource TextOnColorBrush}"/>
                            
                            <!-- Action Type (Read-only display) -->
                            <StackPanel Spacing="4">
                                <TextBlock Text="Type:" Foreground="{DynamicResource TextSecondaryBrush}" FontSize="12"/>
                                <Border Background="{DynamicResource SurfaceBrush}" CornerRadius="4" Padding="8,6">
                                    <TextBlock Text="{Binding SelectedAction.Type}" 
                                               Foreground="{DynamicResource TextPrimaryBrush}" 
                                               FontWeight="SemiBold"/>
                                </Border>
                            </StackPanel>
                            
                            <!-- Coordinates (MouseMove, MouseClick, MouseDown, MouseUp) -->
                            <StackPanel Spacing="4" IsVisible="{Binding ShowCoordinates}">
                                <TextBlock Text="Coordinates:" Foreground="{DynamicResource TextSecondaryBrush}" FontSize="12"/>
                                <Grid ColumnDefinitions="*,8,*">
                                    <TextBox Text="{Binding SelectedAction.X, Converter={StaticResource NullableIntConverter}}" 
                                             Watermark="X"
                                             Background="{DynamicResource SurfaceHoverBrush}"
                                             Foreground="{DynamicResource TextPrimaryBrush}"
                                             BorderThickness="0"
                                             CornerRadius="4"
                                             Padding="8,6"/>
                                    <TextBox Grid.Column="2" 
                                             Text="{Binding SelectedAction.Y, Converter={StaticResource NullableIntConverter}}" 
                                             Watermark="Y"
                                             Background="{DynamicResource SurfaceHoverBrush}"
                                             Foreground="{DynamicResource TextPrimaryBrush}"
                                             BorderThickness="0"
                                             CornerRadius="4"
                                             Padding="8,6"/>
                                </Grid>
                                <Button Command="{Binding CaptureMouseAsync}"
                                        IsVisible="{Binding !IsCapturing}"
                                        Background="{DynamicResource PrimaryBrush}"
                                        Foreground="{DynamicResource TextOnColorBrush}"
                                        HorizontalAlignment="Stretch"
                                        Padding="8,6"
                                        CornerRadius="4">
                                    <StackPanel Orientation="Horizontal" Spacing="6" HorizontalAlignment="Center">
                                        <TextBlock Text="ðŸ“" FontFamily="{StaticResource EmojiFont}"/>
                                        <TextBlock Text="Capture Position"/>
                                    </StackPanel>
                                </Button>
                                <Button Command="{Binding CancelCapture}"
                                        IsVisible="{Binding IsCapturing}"
                                        Background="{DynamicResource DangerBrush}"
                                        Foreground="{DynamicResource TextOnColorBrush}"
                                        HorizontalAlignment="Stretch"
                                        Padding="8,6"
                                        CornerRadius="4">
                                    <StackPanel Orientation="Horizontal" Spacing="6" HorizontalAlignment="Center">
                                        <TextBlock Text="âŒ" FontFamily="{StaticResource EmojiFont}"/>
                                        <TextBlock Text="Cancel Capture"/>
                                    </StackPanel>
                                </Button>
                            </StackPanel>
                            
                            <!-- Absolute/Relative Toggle (MouseMove only) -->
                            <StackPanel Spacing="4" IsVisible="{Binding ShowCoordModeToggle}">
                                <TextBlock Text="Coordinate Mode:" Foreground="{DynamicResource TextSecondaryBrush}" FontSize="12"/>
                                <StackPanel Orientation="Horizontal" Spacing="12">
                                    <RadioButton GroupName="CoordMode" 
                                                 IsChecked="{Binding SelectedAction.IsAbsolute}" 
                                                 Foreground="{DynamicResource TextPrimaryBrush}">
                                        <TextBlock Text="Absolute" FontSize="12"/>
                                    </RadioButton>
                                    <RadioButton GroupName="CoordMode" 
                                                 IsChecked="{Binding !SelectedAction.IsAbsolute}" 
                                                 Foreground="{DynamicResource TextPrimaryBrush}">
                                        <TextBlock Text="Relative" FontSize="12"/>
                                    </RadioButton>
                                </StackPanel>
                            </StackPanel>
                            
                            <!-- Mouse Button (MouseClick, MouseDown, MouseUp) -->
                            <StackPanel Spacing="4" IsVisible="{Binding ShowMouseButton}">
                                <TextBlock Text="Mouse Button:" Foreground="{DynamicResource TextSecondaryBrush}" FontSize="12"/>
                                <ComboBox ItemsSource="{Binding MouseButtons}" 
                                          SelectedItem="{Binding SelectedAction.Button}"
                                          Background="{DynamicResource SurfaceHoverBrush}"
                                          Foreground="{DynamicResource TextPrimaryBrush}"
                                          HorizontalAlignment="Stretch"/>
                            </StackPanel>
                            
                            <!-- Key Code (KeyPress, KeyDown, KeyUp) -->
                            <StackPanel Spacing="4" IsVisible="{Binding ShowKeyCode}">
                                <TextBlock Text="Key:" Foreground="{DynamicResource TextSecondaryBrush}" FontSize="12"/>
                                <Grid ColumnDefinitions="80,8,*">
                                    <TextBox Text="{Binding SelectedAction.KeyCode, Converter={StaticResource NullableIntConverter}}" 
                                             Watermark="Code"
                                             Background="{DynamicResource SurfaceHoverBrush}"
                                             Foreground="{DynamicResource TextPrimaryBrush}"
                                             BorderThickness="0"
                                             CornerRadius="4"
                                             Padding="8,6"
                                             MaxLength="3"/>
                                    <Border Grid.Column="2" 
                                            Background="{DynamicResource SurfaceBrush}" 
                                            CornerRadius="4" 
                                            Padding="12,6">
                                        <TextBlock Text="{Binding SelectedAction.KeyName, FallbackValue='(enter code)'}" 
                                                   Foreground="{DynamicResource TextPrimaryBrush}" 
                                                   FontWeight="SemiBold"
                                                   HorizontalAlignment="Center"/>
                                    </Border>
                                </Grid>
                                <Button Command="{Binding CaptureKeyAsync}"
                                        IsVisible="{Binding !IsCapturing}"
                                        Background="{DynamicResource PrimaryBrush}"
                                        Foreground="{DynamicResource TextOnColorBrush}"
                                        HorizontalAlignment="Stretch"
                                        Padding="8,6"
                                        CornerRadius="4">
                                    <StackPanel Orientation="Horizontal" Spacing="6" HorizontalAlignment="Center">
                                        <TextBlock Text="âŒ¨ï¸" FontFamily="{StaticResource EmojiFont}"/>
                                        <TextBlock Text="Capture Key"/>
                                    </StackPanel>
                                </Button>
                            </StackPanel>
                            
                            <!-- Delay (Delay action only) -->
                            <StackPanel Spacing="4" IsVisible="{Binding ShowDelay}">
                                <CheckBox IsChecked="{Binding SelectedAction.UseRandomDelay}"
                                          Content="Randomize delay"
                                          Foreground="{DynamicResource TextPrimaryBrush}"/>

                                <StackPanel Spacing="4" IsVisible="{Binding ShowFixedDelayInput}">
                                    <TextBlock Text="Delay (ms):" Foreground="{DynamicResource TextSecondaryBrush}" FontSize="12"/>
                                    <TextBox Text="{Binding SelectedAction.DelayMs, Converter={StaticResource NullableIntConverter}}" 
                                             Watermark="ms"
                                             Background="{DynamicResource SurfaceHoverBrush}"
                                             Foreground="{DynamicResource TextPrimaryBrush}"
                                             BorderThickness="0"
                                             CornerRadius="4"
                                             Padding="8,6"/>
                                </StackPanel>

                                <StackPanel Spacing="4" IsVisible="{Binding ShowRandomDelayOptions}">
                                    <TextBlock Text="Random Delay Range (ms):" Foreground="{DynamicResource TextSecondaryBrush}" FontSize="12"/>
                                    <Grid ColumnDefinitions="*,8,*">
                                        <TextBox Text="{Binding SelectedAction.RandomDelayMinMs, Converter={StaticResource NullableIntConverter}}"
                                                 Watermark="Min"
                                                 Background="{DynamicResource SurfaceHoverBrush}"
                                                 Foreground="{DynamicResource TextPrimaryBrush}"
                                                 BorderThickness="0"
                                                 CornerRadius="4"
                                                 Padding="8,6"/>
                                        <TextBox Grid.Column="2"
                                                 Text="{Binding SelectedAction.RandomDelayMaxMs, Converter={StaticResource NullableIntConverter}}"
                                                 Watermark="Max"
                                                 Background="{DynamicResource SurfaceHoverBrush}"
                                                 Foreground="{DynamicResource TextPrimaryBrush}"
                                                 BorderThickness="0"
                                                 CornerRadius="4"
                                                 Padding="8,6"/>
                                    </Grid>
                                </StackPanel>
                            </StackPanel>
                            
                            <!-- Scroll Amount (ScrollVertical, ScrollHorizontal) -->
                            <StackPanel Spacing="4" IsVisible="{Binding ShowScrollAmount}">
                                <TextBlock Text="Scroll Amount:" Foreground="{DynamicResource TextSecondaryBrush}" FontSize="12"/>
                                <TextBox Text="{Binding SelectedAction.ScrollAmount, Converter={StaticResource NullableIntConverter}}" 
                                         Watermark="Amount"
                                         Background="{DynamicResource SurfaceHoverBrush}"
                                         Foreground="{DynamicResource TextPrimaryBrush}"
                                         BorderThickness="0"
                                         CornerRadius="4"
                                         Padding="8,6"/>
                                <TextBlock Text="(+) up/right, (-) down/left" Foreground="{DynamicResource TextSecondaryBrush}" FontSize="11"/>
                            </StackPanel>
                            
                            <!-- Text Input (TextInput action only) -->
                            <StackPanel Spacing="4" IsVisible="{Binding ShowTextInput}">
                                <TextBlock Text="Text to Type:" Foreground="{DynamicResource TextSecondaryBrush}" FontSize="12"/>
                                <TextBox Text="{Binding SelectedAction.Text}" 
                                         Watermark="Enter text to type..."
                                         Background="{DynamicResource SurfaceHoverBrush}"
                                         Foreground="{DynamicResource TextPrimaryBrush}"
                                         BorderThickness="0"
                                         CornerRadius="4"
                                         Padding="8,6"
                                         AcceptsReturn="False"
                                         TextWrapping="NoWrap"
                                         MaxLength="500"/>
                                <TextBlock Text="Each character is typed as a separate key press (max 500 chars)" 
                                           Foreground="{DynamicResource TextSecondaryBrush}" 
                                           FontSize="11"
                                           TextWrapping="Wrap"/>
                            </StackPanel>
                        </StackPanel>
                        
                        <!-- No Selection Message -->
                        <TextBlock Text="Select an action to edit its properties"
                                   IsVisible="{Binding !HasSelectedAction}"
                                   Foreground="{DynamicResource TextSecondaryBrush}"
                                   FontStyle="Italic"
                                   HorizontalAlignment="Center"
                                   Margin="0,20"/>
                        
                    </StackPanel>
                </ScrollViewer>
            </Border>
        </Grid>
        
        <!-- Footer: Status + Actions -->
        <Border Grid.Row="2" Margin="0,16,0,0">
            <Grid ColumnDefinitions="*,Auto">
                <!-- Undo/Redo + Clear -->
                <StackPanel Orientation="Horizontal" Spacing="8">
                    <Button Command="{Binding Undo}"
                            IsEnabled="{Binding CanUndo}"
                            ToolTip.Tip="Undo"
                            Background="{DynamicResource SurfaceHoverBrush}"
                            Foreground="{DynamicResource TextPrimaryBrush}"
                            Padding="12,8"
                            CornerRadius="4">
                        <StackPanel Orientation="Horizontal" Spacing="4">
                            <TextBlock Text="â†©"/>
                            <TextBlock Text="Undo"/>
                        </StackPanel>
                    </Button>
                    <Button Command="{Binding Redo}"
                            IsEnabled="{Binding CanRedo}"
                            ToolTip.Tip="Redo"
                            Background="{DynamicResource SurfaceHoverBrush}"
                            Foreground="{DynamicResource TextPrimaryBrush}"
                            Padding="12,8"
                            CornerRadius="4">
                        <StackPanel Orientation="Horizontal" Spacing="4">
                            <TextBlock Text="â†ª"/>
                            <TextBlock Text="Redo"/>
                        </StackPanel>
                    </Button>
                    <Button Command="{Binding ClearAll}"
                            IsEnabled="{Binding HasActions}"
                            ToolTip.Tip="Clear All"
                            Background="{DynamicResource SurfaceHoverBrush}"
                            Foreground="{DynamicResource TextPrimaryBrush}"
                            Padding="12,8"
                            CornerRadius="4">
                        <StackPanel Orientation="Horizontal" Spacing="4">
                            <TextBlock Text="ðŸ—‘ï¸" FontFamily="{StaticResource EmojiFont}"/>
                            <TextBlock Text="Clear"/>
                        </StackPanel>
                    </Button>
                </StackPanel>
                
                <!-- Save/Load -->
                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8">
                    <Button Command="{Binding LoadMacroAsync}"
                            Background="{DynamicResource SurfaceHoverBrush}"
                            Foreground="{DynamicResource TextPrimaryBrush}"
                            Padding="12,8"
                            CornerRadius="4">
                        <StackPanel Orientation="Horizontal" Spacing="4">
                            <TextBlock Text="ðŸ“‚" FontFamily="{StaticResource EmojiFont}"/>
                            <TextBlock Text="Load"/>
                        </StackPanel>
                    </Button>
                    <Button Command="{Binding SaveMacroAsync}"
                            IsEnabled="{Binding HasActions}"
                            Background="{DynamicResource PrimaryBrush}"
                            Foreground="{DynamicResource TextOnColorBrush}"
                            Padding="12,8"
                            CornerRadius="4">
                        <StackPanel Orientation="Horizontal" Spacing="4">
                            <TextBlock Text="ðŸ’¾" FontFamily="{StaticResource EmojiFont}"/>
                            <TextBlock Text="Save"/>
                        </StackPanel>
                    </Button>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</UserControl>
